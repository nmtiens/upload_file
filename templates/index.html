<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Folders - Supabase Direct</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 18px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: 500;
      }

      .error {
        background-color: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }

      .success {
        background-color: #efe;
        color: #363;
        border: 1px solid #cfc;
      }

      .warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .folders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .folder-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .folder-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
      }

      .folder-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .folder-card.database-only::before {
        background: linear-gradient(90deg, #4caf50, #45a049);
      }

      .folder-card.storage-only::before {
        background: linear-gradient(90deg, #ff9800, #f57c00);
      }

      .folder-card.both::before {
        background: linear-gradient(90deg, #2196f3, #1976d2);
      }

      .folder-name {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .folder-name::before {
        content: "üìÅ";
        font-size: 24px;
      }

      .folder-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge.database {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .badge.storage {
        background: #fff3e0;
        color: #ef6c00;
      }

      .badge.both {
        background: #e3f2fd;
        color: #1565c0;
      }

      .debug-panel {
        margin-top: 40px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
      }

      .debug-header {
        background: #343a40;
        color: white;
        padding: 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .debug-content {
        padding: 20px;
        display: none;
      }

      .debug-content.show {
        display: block;
      }

      .debug-section {
        margin-bottom: 20px;
      }

      .debug-section h4 {
        margin-bottom: 10px;
        color: #495057;
      }

      pre {
        background: #f1f3f4;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 12px;
        line-height: 1.4;
        max-height: 300px;
        overflow-y: auto;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        .folders-grid {
          grid-template-columns: 1fr;
        }

        .folder-info {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìÅ Qu·∫£n l√Ω Folders</h1>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadFolders()" id="refreshBtn">
          üîÑ L√†m m·ªõi
        </button>
        <button class="btn btn-secondary" onclick="toggleDebug()">
          üîç Debug
        </button>
        <button class="btn btn-secondary" onclick="testConnection()">
          üîó Test Connection
        </button>
      </div>

      <div id="loadingMsg" class="loading" style="display: none">
        <div class="spinner"></div>
        ƒêang t·∫£i danh s√°ch folders t·ª´ Supabase...
      </div>

      <div id="messageContainer"></div>

      <!-- Stats Section -->
      <div id="statsSection" class="stats-grid" style="display: none">
        <div class="stat-card">
          <div class="stat-number" id="totalFolders">0</div>
          <div class="stat-label">T·ªïng Folders</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="databaseFolders">0</div>
          <div class="stat-label">Database</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="storageFolders">0</div>
          <div class="stat-label">Storage</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="syncedFolders">0</div>
          <div class="stat-label">ƒê·ªìng b·ªô</div>
        </div>
      </div>

      <!-- Folders Grid -->
      <div id="foldersGrid" class="folders-grid"></div>

      <!-- Debug Panel -->
      <div class="debug-panel">
        <div class="debug-header" onclick="toggleDebug()">
          <span>üîç Debug Information</span>
          <span id="debugToggle">‚ñº</span>
        </div>
        <div id="debugContent" class="debug-content">
          <div class="debug-section">
            <h4>Supabase Connection</h4>
            <pre id="connectionInfo">Ch∆∞a test connection...</pre>
          </div>
          <div class="debug-section">
            <h4>Database Query Result</h4>
            <pre id="databaseData">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
          </div>
          <div class="debug-section">
            <h4>Storage Query Result</h4>
            <pre id="storageData">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
          </div>
          <div class="debug-section">
            <h4>Combined Result</h4>
            <pre id="combinedData">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // C·∫•u h√¨nh Supabase - THAY ƒê·ªîI C√ÅC TH√îNG TIN N√ÄY
      const SUPABASE_URL = "https://mbigeepdbascromjmanh.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1iaWdlZXBkYmFzY3JvbWptYW5oIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0OTIyMTUyMCwiZXhwIjoyMDY0Nzk3NTIwfQ.OAMDTWa2EZQUiPKlcFTvQXcBubQnkKst5kRnOiK8Tf0";
      const SUPABASE_BUCKET = "file-uploads";

      // Kh·ªüi t·∫°o Supabase client
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      let currentData = null;

      // H√†m ki·ªÉm tra k·∫øt n·ªëi
      async function testConnection() {
        showMessage("ƒêang ki·ªÉm tra k·∫øt n·ªëi...", "warning");

        try {
          // Test database connection
          const { data, error } = await supabase
            .from("submissions")
            .select("id")
            .limit(1);

          if (error) {
            throw new Error(`Database error: ${error.message}`);
          }

          // Test storage connection
          const { data: storageData, error: storageError } =
            await supabase.storage.from(SUPABASE_BUCKET).list("", { limit: 1 });

          if (storageError) {
            throw new Error(`Storage error: ${storageError.message}`);
          }

          document.getElementById(
            "connectionInfo"
          ).textContent = `‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!\nDatabase: OK\nStorage: OK\nTime: ${new Date().toLocaleString()}`;

          showMessage("‚úÖ K·∫øt n·ªëi Supabase th√†nh c√¥ng!", "success");
        } catch (error) {
          console.error("Connection test failed:", error);
          document.getElementById(
            "connectionInfo"
          ).textContent = `‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`;
          showMessage(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, "error");
        }
      }

      // H√†m l·∫•y folders t·ª´ database
      async function getFoldersFromDatabase() {
        try {
          const { data, error } = await supabase
            .from("submissions")
            .select("folder_name");

          if (error) {
            throw error;
          }

          // ƒê·∫øm s·ªë l∆∞·ª£ng submissions theo folder
          const folderCounts = {};
          data.forEach((item) => {
            const folderName = item.folder_name;
            if (folderName && folderName.trim()) {
              const trimmedName = folderName.trim();
              folderCounts[trimmedName] = (folderCounts[trimmedName] || 0) + 1;
            }
          });

          const result = Object.entries(folderCounts).map(([name, count]) => ({
            name,
            source: "database",
            submission_count: count,
          }));

          document.getElementById("databaseData").textContent = JSON.stringify(
            result,
            null,
            2
          );
          return result;
        } catch (error) {
          console.error("Database query error:", error);
          document.getElementById(
            "databaseData"
          ).textContent = `Error: ${error.message}`;
          return [];
        }
      }

      // H√†m l·∫•y folders t·ª´ storage
      async function getFoldersFromStorage() {
        try {
          const { data, error } = await supabase.storage
            .from(SUPABASE_BUCKET)
            .list("", { limit: 1000 });

          if (error) {
            throw error;
          }

          const storageFolders = {};

          data.forEach((item) => {
            const fileName = item.name;
            let folderName = null;

            // Ki·ªÉm tra n·∫øu l√† file trong subfolder
            if (fileName.includes("/")) {
              folderName = fileName.split("/")[0];
            } else if (!fileName.includes(".")) {
              // Kh√¥ng c√≥ extension, c√≥ th·ªÉ l√† folder
              folderName = fileName;
            }

            if (folderName && folderName.trim()) {
              const trimmedName = folderName.trim();

              if (!storageFolders[trimmedName]) {
                storageFolders[trimmedName] = {
                  name: trimmedName,
                  source: "storage",
                  file_count: 0,
                  total_size: 0,
                  last_modified: null,
                };
              }

              // Ch·ªâ ƒë·∫øm file th·ª±c s·ª±
              if (fileName.includes("/") || fileName.includes(".")) {
                const fileSize = (item.metadata && item.metadata.size) || 0;
                storageFolders[trimmedName].file_count += 1;
                storageFolders[trimmedName].total_size += fileSize;

                // C·∫≠p nh·∫≠t th·ªùi gian s·ª≠a ƒë·ªïi
                const fileUpdated = item.updated_at;
                if (
                  fileUpdated &&
                  (!storageFolders[trimmedName].last_modified ||
                    fileUpdated > storageFolders[trimmedName].last_modified)
                ) {
                  storageFolders[trimmedName].last_modified = fileUpdated;
                }
              }
            }
          });

          const result = Object.values(storageFolders);
          document.getElementById("storageData").textContent = JSON.stringify(
            result,
            null,
            2
          );
          return result;
        } catch (error) {
          console.error("Storage query error:", error);
          document.getElementById(
            "storageData"
          ).textContent = `Error: ${error.message}`;
          return [];
        }
      }

      // H√†m format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // H√†m k·∫øt h·ª£p d·ªØ li·ªáu
      function combineData(databaseFolders, storageFolders) {
        const allFolderNames = new Set();

        // Collect all folder names
        databaseFolders.forEach((folder) => allFolderNames.add(folder.name));
        storageFolders.forEach((folder) => allFolderNames.add(folder.name));

        const combinedFolders = Array.from(allFolderNames)
          .sort()
          .map((folderName) => {
            const dbInfo = databaseFolders.find((f) => f.name === folderName);
            const storageInfo = storageFolders.find(
              (f) => f.name === folderName
            );

            return {
              name: folderName,
              exists_in_database: !!dbInfo,
              exists_in_storage: !!storageInfo,
              submission_count: dbInfo ? dbInfo.submission_count : 0,
              file_count: storageInfo ? storageInfo.file_count : 0,
              total_size: storageInfo ? storageInfo.total_size : 0,
              total_size_human: storageInfo
                ? formatFileSize(storageInfo.total_size)
                : "0 B",
              last_modified: storageInfo ? storageInfo.last_modified : null,
              status:
                dbInfo && storageInfo
                  ? "both"
                  : dbInfo
                  ? "database-only"
                  : "storage-only",
            };
          });

        const result = {
          database_folders: databaseFolders,
          storage_folders: storageFolders,
          combined_folders: combinedFolders,
          summary: {
            total_folders: combinedFolders.length,
            database_only: combinedFolders.filter(
              (f) => f.exists_in_database && !f.exists_in_storage
            ).length,
            storage_only: combinedFolders.filter(
              (f) => f.exists_in_storage && !f.exists_in_database
            ).length,
            both_sources: combinedFolders.filter(
              (f) => f.exists_in_database && f.exists_in_storage
            ).length,
          },
        };

        document.getElementById("combinedData").textContent = JSON.stringify(
          result,
          null,
          2
        );
        return result;
      }

      // H√†m ch√≠nh load folders
      async function loadFolders() {
        const loadingMsg = document.getElementById("loadingMsg");
        const refreshBtn = document.getElementById("refreshBtn");
        const statsSection = document.getElementById("statsSection");
        const foldersGrid = document.getElementById("foldersGrid");

        try {
          // Show loading
          loadingMsg.style.display = "block";
          refreshBtn.disabled = true;
          refreshBtn.textContent = "‚è≥ ƒêang t·∫£i...";
          clearMessages();

          console.log("Loading folders from Supabase...");

          // Ki·ªÉm tra c·∫•u h√¨nh
          if (SUPABASE_URL === "YOUR_SUPABASE_URL") {
            throw new Error(
              "Vui l√≤ng c·∫•u h√¨nh SUPABASE_URL v√† SUPABASE_ANON_KEY"
            );
          }

          // L·∫•y d·ªØ li·ªáu t·ª´ c·∫£ hai ngu·ªìn
          const [databaseFolders, storageFolders] = await Promise.all([
            getFoldersFromDatabase(),
            getFoldersFromStorage(),
          ]);

          // K·∫øt h·ª£p d·ªØ li·ªáu
          const combinedData = combineData(databaseFolders, storageFolders);
          currentData = combinedData;

          // C·∫≠p nh·∫≠t stats
          updateStats(combinedData.summary);

          // Render folders
          renderFolders(combinedData.combined_folders);

          showMessage(
            `‚úÖ T·∫£i th√†nh c√¥ng ${combinedData.summary.total_folders} folders`,
            "success"
          );
        } catch (error) {
          console.error("Error loading folders:", error);
          showMessage(`‚ùå L·ªói: ${error.message}`, "error");
          foldersGrid.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">üòû</div><h3>Kh√¥ng th·ªÉ t·∫£i danh s√°ch folders</h3></div>';
        } finally {
          loadingMsg.style.display = "none";
          refreshBtn.disabled = false;
          refreshBtn.textContent = "üîÑ L√†m m·ªõi";
        }
      }

      // H√†m c·∫≠p nh·∫≠t stats
      function updateStats(summary) {
        document.getElementById("totalFolders").textContent =
          summary.total_folders;
        document.getElementById("databaseFolders").textContent =
          summary.database_only + summary.both_sources;
        document.getElementById("storageFolders").textContent =
          summary.storage_only + summary.both_sources;
        document.getElementById("syncedFolders").textContent =
          summary.both_sources;
        document.getElementById("statsSection").style.display = "grid";
      }

      // H√†m render folders
      function renderFolders(folders) {
        const foldersGrid = document.getElementById("foldersGrid");

        if (!folders || folders.length === 0) {
          foldersGrid.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">üìÇ</div>
                      <h3>Kh√¥ng c√≥ folders n√†o</h3>
                      <p>Ch∆∞a t√¨m th·∫•y folder n√†o trong database ho·∫∑c storage</p>
                  </div>
              `;
          return;
        }

        foldersGrid.innerHTML = folders
          .map(
            (folder) => `
              <div class="folder-card ${folder.status}">
                  <div class="folder-name">${escapeHtml(folder.name)}</div>

                  <div class="folder-info">
                      <div class="info-item">
                          <span>üìä</span>
                          <span>Submissions: ${folder.submission_count}</span>
                      </div>
                      <div class="info-item">
                          <span>üìÅ</span>
                          <span>Files: ${folder.file_count}</span>
                      </div>
                      <div class="info-item">
                          <span>üíæ</span>
                          <span>Size: ${folder.total_size_human}</span>
                      </div>
                      ${
                        folder.last_modified
                          ? `
                          <div class="info-item">
                              <span>üïê</span>
                              <span>Modified: ${formatDate(
                                folder.last_modified
                              )}</span>
                          </div>
                      `
                          : ""
                      }
                  </div>

                  <div class="badges">
                      ${
                        folder.exists_in_database
                          ? '<span class="badge database">Database</span>'
                          : ""
                      }
                      ${
                        folder.exists_in_storage
                          ? '<span class="badge storage">Storage</span>'
                          : ""
                      }
                      ${
                        folder.exists_in_database && folder.exists_in_storage
                          ? '<span class="badge both">Synced</span>'
                          : ""
                      }
                  </div>
              </div>
          `
          )
          .join("");
      }

      // Utility functions
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        try {
          return new Date(dateString).toLocaleString("vi-VN");
        } catch (e) {
          return dateString;
        }
      }

      function showMessage(message, type) {
        const container = document.getElementById("messageContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        container.appendChild(messageDiv);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 5000);
      }

      function clearMessages() {
        document.getElementById("messageContainer").innerHTML = "";
      }

      function toggleDebug() {
        const content = document.getElementById("debugContent");
        const toggle = document.getElementById("debugToggle");

        if (content.classList.contains("show")) {
          content.classList.remove("show");
          toggle.textContent = "‚ñº";
        } else {
          content.classList.add("show");
          toggle.textContent = "‚ñ≤";
        }
      }

      // Load khi trang ƒë∆∞·ª£c t·∫£i
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Page loaded");

        // Ki·ªÉm tra c·∫•u h√¨nh
        if (SUPABASE_URL === "YOUR_SUPABASE_URL") {
          showMessage(
            "‚ö†Ô∏è Vui l√≤ng c·∫•u h√¨nh Supabase URL v√† API Key trong code",
            "warning"
          );
          return;
        }

        // Auto load folders
        loadFolders();
      });

      // Auto refresh every 2 minutes
      setInterval(loadFolders, 120000);
    </script>
  </body>
</html>
