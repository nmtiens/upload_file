<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug API Folders - Render + Supabase</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .content {
        padding: 30px;
      }

      .test-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
      }

      .test-section h3 {
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .url-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        margin-bottom: 15px;
        font-family: monospace;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        margin-right: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.success {
        background: #28a745;
      }

      .btn.danger {
        background: #dc3545;
      }

      .result-box {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #4a5568;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: 10px;
      }

      .status-ok {
        background: #28a745;
      }
      .status-error {
        background: #dc3545;
      }
      .status-warning {
        background: #ffc107;
      }
      .status-loading {
        background: #007bff;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .info-card {
        background: #e8f4fd;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #0066cc;
      }

      .info-card h4 {
        color: #0066cc;
        margin-bottom: 10px;
      }

      .log-entry {
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 4px;
        font-size: 0.85em;
      }

      .log-info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 3px solid #17a2b8;
      }

      .log-success {
        background: #d4edda;
        color: #155724;
        border-left: 3px solid #28a745;
      }

      .log-error {
        background: #f8d7da;
        color: #721c24;
        border-left: 3px solid #dc3545;
      }

      .log-warning {
        background: #fff3cd;
        color: #856404;
        border-left: 3px solid #ffc107;
      }

      .tabs {
        display: flex;
        background: #f1f3f4;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
      }

      .tab {
        padding: 12px 20px;
        cursor: pointer;
        border: none;
        background: transparent;
        font-size: 1em;
        color: #666;
        transition: all 0.3s ease;
      }

      .tab.active {
        background: white;
        color: #333;
        font-weight: 600;
      }

      .tab-content {
        display: none;
        background: white;
        padding: 20px;
        border-radius: 0 0 8px 8px;
        border: 1px solid #e9ecef;
      }

      .tab-content.active {
        display: block;
      }

      .quick-tests {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .network-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-family: monospace;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🔧 Debug API Folders</h1>
        <p>Kiểm tra kết nối Render ↔ Supabase</p>
      </div>

      <div class="content">
        <!-- Thông tin cơ bản -->
        <div class="info-grid">
          <div class="info-card">
            <h4>🌐 URL Hiện Tại</h4>
            <div
              id="currentUrl"
              style="font-family: monospace; word-break: break-all"
            ></div>
          </div>
          <div class="info-card">
            <h4>⚡ Trạng Thái Kết Nối</h4>
            <div id="connectionStatus">Đang kiểm tra...</div>
          </div>
          <div class="info-card">
            <h4>🕐 Thời Gian</h4>
            <div id="currentTime"></div>
          </div>
          <div class="info-card">
            <h4>🌏 Vị Trí</h4>
            <div id="locationInfo">Đang xác định...</div>
          </div>
        </div>

        <!-- URL Configuration -->
        <div class="test-section">
          <h3>
            🔗 Cấu Hình URL API
            <span class="status-indicator" id="urlStatus"></span>
          </h3>
          <input
            type="text"
            id="apiUrl"
            class="url-input"
            placeholder="Nhập URL API của bạn (ví dụ: https://your-app.onrender.com/api/folders)"
          />
          <div class="quick-tests">
            <button class="btn" onclick="detectApiUrl()">
              🔍 Tự Động Phát Hiện
            </button>
            <button class="btn secondary" onclick="setLocalhost()">
              💻 Localhost
            </button>
            <button class="btn secondary" onclick="setRenderExample()">
              🚀 Render Example
            </button>
            <button class="btn success" onclick="testConnection()">
              🧪 Test Kết Nối
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('basic')">
            🔍 Test Cơ Bản
          </button>
          <button class="tab" onclick="switchTab('advanced')">
            ⚙️ Test Nâng Cao
          </button>
          <button class="tab" onclick="switchTab('logs')">📋 Logs</button>
          <button class="tab" onclick="switchTab('network')">🌐 Network</button>
        </div>

        <!-- Tab Content: Basic Tests -->
        <div id="basic" class="tab-content active">
          <h3>🔍 Kiểm Tra API Cơ Bản</h3>
          <div class="quick-tests">
            <button class="btn" onclick="testFoldersSimple()">
              📁 GET /folders/simple
            </button>
            <button class="btn" onclick="testFolders()">📂 GET /folders</button>
            <button class="btn" onclick="testApiHealth()">
              ❤️ Health Check
            </button>
            <button class="btn secondary" onclick="testCORS()">
              🔐 Test CORS
            </button>
          </div>
          <div id="basicResults" class="result-box">
            Chưa có kết quả test...
          </div>
        </div>

        <!-- Tab Content: Advanced Tests -->
        <div id="advanced" class="tab-content">
          <h3>⚙️ Kiểm Tra Nâng Cao</h3>
          <div class="quick-tests">
            <button class="btn" onclick="testHeaders()">📋 Headers</button>
            <button class="btn" onclick="testEncoding()">
              🔤 UTF-8 Encoding
            </button>
            <button class="btn" onclick="testSupabaseConnection()">
              🐘 Supabase Connection
            </button>
            <button class="btn danger" onclick="testCreateFolder()">
              ➕ Test Create Folder
            </button>
          </div>
          <div>
            <h4>Test Tạo Folder:</h4>
            <input
              type="text"
              id="testFolderName"
              placeholder="Tên folder test (có dấu)"
              value="Test Folder Có Dấu 123"
              style="width: 300px; padding: 8px; margin: 10px 0"
            />
          </div>
          <div id="advancedResults" class="result-box">
            Chưa có kết quả test...
          </div>
        </div>

        <!-- Tab Content: Logs -->
        <div id="logs" class="tab-content">
          <h3>📋 Logs Chi Tiết</h3>
          <button class="btn secondary" onclick="clearLogs()">
            🗑️ Xóa Logs
          </button>
          <button class="btn" onclick="exportLogs()">💾 Export Logs</button>
          <div id="logContainer"></div>
        </div>

        <!-- Tab Content: Network -->
        <div id="network" class="tab-content">
          <h3>🌐 Thông Tin Network</h3>
          <button class="btn" onclick="getNetworkInfo()">
            🔄 Refresh Network Info
          </button>
          <div id="networkInfo" class="network-info">
            Đang tải thông tin network...
          </div>
        </div>
      </div>
    </div>

    <script>
      let logs = [];
      let apiBaseUrl = "";

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        updateCurrentInfo();
        detectApiUrl();
        setInterval(updateCurrentInfo, 1000);
      });

      function updateCurrentInfo() {
        document.getElementById("currentUrl").textContent =
          window.location.href;
        document.getElementById("currentTime").textContent =
          new Date().toLocaleString("vi-VN");

        // Update connection status
        updateConnectionStatus();
      }

      function updateConnectionStatus() {
        const status = navigator.onLine ? "Online ✅" : "Offline ❌";
        document.getElementById("connectionStatus").textContent = status;
      }

      function detectApiUrl() {
        const currentOrigin = window.location.origin;

        // Nếu đang chạy trên localhost
        if (
          currentOrigin.includes("localhost") ||
          currentOrigin.includes("127.0.0.1")
        ) {
          apiBaseUrl = "http://localhost:5000";
        }
        // Nếu đang chạy trên Render hoặc domain khác
        else {
          apiBaseUrl = currentOrigin;
        }

        document.getElementById(
          "apiUrl"
        ).value = `${apiBaseUrl}/api/folders/simple`;
        updateUrlStatus("detected");
        log("info", `Đã phát hiện API URL: ${apiBaseUrl}`);
      }

      function setLocalhost() {
        apiBaseUrl = "http://localhost:5000";
        document.getElementById(
          "apiUrl"
        ).value = `${apiBaseUrl}/api/folders/simple`;
        updateUrlStatus("localhost");
        log("info", "Đã đặt URL localhost");
      }

      function setRenderExample() {
        const renderUrl = prompt(
          "Nhập URL Render của bạn (ví dụ: https://your-app.onrender.com):"
        );
        if (renderUrl) {
          apiBaseUrl = renderUrl.replace(/\/$/, ""); // Remove trailing slash
          document.getElementById(
            "apiUrl"
          ).value = `${apiBaseUrl}/api/folders/simple`;
          updateUrlStatus("render");
          log("info", `Đã đặt URL Render: ${apiBaseUrl}`);
        }
      }

      function updateUrlStatus(type) {
        const indicator = document.getElementById("urlStatus");
        indicator.className = "status-indicator ";

        switch (type) {
          case "detected":
            indicator.className += "status-warning";
            break;
          case "localhost":
            indicator.className += "status-ok";
            break;
          case "render":
            indicator.className += "status-ok";
            break;
          case "loading":
            indicator.className += "status-loading";
            break;
          case "error":
            indicator.className += "status-error";
            break;
        }
      }

      async function testConnection() {
        const url = document.getElementById("apiUrl").value;
        if (!url) {
          log("error", "Vui lòng nhập URL API");
          return;
        }

        updateUrlStatus("loading");
        log("info", `Đang test kết nối: ${url}`);

        try {
          const startTime = performance.now();
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept: "application/json; charset=utf-8",
              "Accept-Charset": "utf-8",
            },
          });
          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          const result = {
            status: response.status,
            statusText: response.statusText,
            headers: Object.fromEntries(response.headers.entries()),
            responseTime: `${responseTime}ms`,
            url: response.url,
          };

          if (response.ok) {
            const data = await response.text();
            result.data = data;
            updateUrlStatus("ok");
            log("success", `Kết nối thành công! (${responseTime}ms)`);
          } else {
            updateUrlStatus("error");
            log(
              "error",
              `Kết nối thất bại: ${response.status} ${response.statusText}`
            );
          }

          displayResult("basicResults", result);
        } catch (error) {
          updateUrlStatus("error");
          log("error", `Lỗi kết nối: ${error.message}`);
          displayResult("basicResults", {
            error: error.message,
            stack: error.stack,
          });
        }
      }

      async function testFoldersSimple() {
        await testEndpoint("/api/folders/simple", "GET");
      }

      async function testFolders() {
        await testEndpoint("/api/folders", "GET");
      }

      async function testApiHealth() {
        await testEndpoint("/health", "GET");
      }

      async function testCORS() {
        const url = getApiUrl("/api/folders/simple");
        log("info", `Testing CORS: ${url}`);

        try {
          const response = await fetch(url, {
            method: "OPTIONS",
            headers: {
              Origin: window.location.origin,
              "Access-Control-Request-Method": "GET",
              "Access-Control-Request-Headers": "Content-Type",
            },
          });

          const corsHeaders = {};
          response.headers.forEach((value, key) => {
            if (key.toLowerCase().startsWith("access-control-")) {
              corsHeaders[key] = value;
            }
          });

          displayResult("basicResults", {
            corsTest: true,
            status: response.status,
            corsHeaders: corsHeaders,
          });

          if (Object.keys(corsHeaders).length > 0) {
            log("success", "CORS headers được tìm thấy");
          } else {
            log("warning", "Không tìm thấy CORS headers");
          }
        } catch (error) {
          log("error", `CORS test failed: ${error.message}`);
          displayResult("basicResults", { corsError: error.message });
        }
      }

      async function testHeaders() {
        const url = getApiUrl("/api/folders/simple");
        log("info", `Testing headers: ${url}`);

        try {
          const response = await fetch(url, {
            method: "HEAD",
          });

          const headers = Object.fromEntries(response.headers.entries());

          displayResult("advancedResults", {
            headTest: true,
            status: response.status,
            headers: headers,
          });

          log("success", "Headers test completed");
        } catch (error) {
          log("error", `Headers test failed: ${error.message}`);
          displayResult("advancedResults", { headError: error.message });
        }
      }

      async function testEncoding() {
        log("info", "Testing UTF-8 encoding...");

        const testStrings = [
          "Thư mục có dấu",
          "Tài liệu tiếng Việt",
          "Đề tài nghiên cứu",
          "Báo cáo tháng 12/2024",
        ];

        const encodingResults = {};

        testStrings.forEach((str) => {
          try {
            const encoded = encodeURIComponent(str);
            const decoded = decodeURIComponent(encoded);
            encodingResults[str] = {
              original: str,
              encoded: encoded,
              decoded: decoded,
              success: decoded === str,
            };
          } catch (error) {
            encodingResults[str] = {
              original: str,
              error: error.message,
              success: false,
            };
          }
        });

        displayResult("advancedResults", {
          encodingTest: true,
          results: encodingResults,
        });

        const allSuccess = Object.values(encodingResults).every(
          (r) => r.success
        );
        if (allSuccess) {
          log("success", "UTF-8 encoding test passed");
        } else {
          log("warning", "UTF-8 encoding test có vấn đề");
        }
      }

      async function testSupabaseConnection() {
        log("info", "Testing Supabase connection...");

        // Test qua API endpoint
        await testEndpoint("/api/folders/simple", "GET", {
          supabaseTest: true,
        });
      }

      async function testCreateFolder() {
        const folderName =
          document.getElementById("testFolderName").value || "Test Folder";
        const url = getApiUrl("/api/folders");

        log("info", `Testing create folder: ${folderName}`);

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json; charset=utf-8",
              Accept: "application/json; charset=utf-8",
            },
            body: JSON.stringify({
              name: folderName,
              test: true, // Đánh dấu đây là test
            }),
          });

          const result = await response.json();

          displayResult("advancedResults", {
            createFolderTest: true,
            folderName: folderName,
            status: response.status,
            result: result,
          });

          if (response.ok) {
            log("success", `Tạo folder test thành công: ${folderName}`);
          } else {
            log(
              "error",
              `Tạo folder test thất bại: ${result.error || "Unknown error"}`
            );
          }
        } catch (error) {
          log("error", `Create folder test failed: ${error.message}`);
          displayResult("advancedResults", {
            createFolderError: error.message,
          });
        }
      }

      async function testEndpoint(endpoint, method = "GET", options = {}) {
        const url = getApiUrl(endpoint);
        log("info", `Testing ${method} ${endpoint}`);

        try {
          const startTime = performance.now();
          const response = await fetch(url, {
            method: method,
            headers: {
              Accept: "application/json; charset=utf-8",
              "Accept-Charset": "utf-8",
            },
          });
          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          let data;
          const contentType = response.headers.get("content-type");

          if (contentType && contentType.includes("application/json")) {
            data = await response.json();
          } else {
            data = await response.text();
          }

          const result = {
            endpoint: endpoint,
            method: method,
            status: response.status,
            statusText: response.statusText,
            responseTime: `${responseTime}ms`,
            contentType: contentType,
            data: data,
            headers: Object.fromEntries(response.headers.entries()),
            ...options,
          };

          const targetId = options.supabaseTest
            ? "advancedResults"
            : "basicResults";
          displayResult(targetId, result);

          if (response.ok) {
            log(
              "success",
              `${method} ${endpoint} - Success (${responseTime}ms)`
            );
          } else {
            log("error", `${method} ${endpoint} - Failed: ${response.status}`);
          }
        } catch (error) {
          log("error", `${method} ${endpoint} - Error: ${error.message}`);
          const targetId = options.supabaseTest
            ? "advancedResults"
            : "basicResults";
          displayResult(targetId, {
            endpoint: endpoint,
            method: method,
            error: error.message,
            ...options,
          });
        }
      }

      function getApiUrl(endpoint) {
        const baseUrl = document
          .getElementById("apiUrl")
          .value.replace("/api/folders/simple", "");
        return baseUrl + endpoint;
      }

      function displayResult(containerId, data) {
        const container = document.getElementById(containerId);
        container.textContent = JSON.stringify(data, null, 2);
      }

      function log(type, message) {
        const timestamp = new Date().toLocaleTimeString("vi-VN");
        const logEntry = {
          timestamp: timestamp,
          type: type,
          message: message,
        };

        logs.push(logEntry);

        // Update logs tab
        updateLogsDisplay();
      }

      function updateLogsDisplay() {
        const container = document.getElementById("logContainer");
        container.innerHTML = "";

        logs
          .slice(-50)
          .reverse()
          .forEach((log) => {
            const div = document.createElement("div");
            div.className = `log-entry log-${log.type}`;
            div.textContent = `[${log.timestamp}] ${log.message}`;
            container.appendChild(div);
          });
      }

      function clearLogs() {
        logs = [];
        updateLogsDisplay();
      }

      function exportLogs() {
        const logsText = logs
          .map(
            (log) =>
              `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`
          )
          .join("\n");
        const blob = new Blob([logsText], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `api-debug-logs-${new Date()
          .toISOString()
          .slice(0, 19)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Remove active from all tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabName).classList.add("active");

        // Mark selected tab as active
        event.target.classList.add("active");
      }

      async function getNetworkInfo() {
        const networkInfo = document.getElementById("networkInfo");

        const info = {
          userAgent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform,
          cookieEnabled: navigator.cookieEnabled,
          onLine: navigator.onLine,
          connection: navigator.connection
            ? {
                effectiveType: navigator.connection.effectiveType,
                downlink: navigator.connection.downlink,
                rtt: navigator.connection.rtt,
              }
            : "Not available",
          location: {
            href: window.location.href,
            origin: window.location.origin,
            protocol: window.location.protocol,
            host: window.location.host,
          },
          screen: {
            width: screen.width,
            height: screen.height,
            colorDepth: screen.colorDepth,
          },
          timestamp: new Date().toISOString(),
        };

        // Test DNS resolution
        try {
          const dnsStart = performance.now();
          await fetch("https://dns.google/resolve?name=google.com&type=A");
          const dnsEnd = performance.now();
          info.dnsResolution = `${Math.round(dnsEnd - dnsStart)}ms`;
        } catch {
          info.dnsResolution = "Failed";
        }

        networkInfo.textContent = JSON.stringify(info, null, 2);
        log("info", "Network info updated");
      }

      // Auto-detect location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            document.getElementById(
              "locationInfo"
            ).textContent = `${position.coords.latitude.toFixed(
              2
            )}, ${position.coords.longitude.toFixed(2)}`;
          },
          () => {
            document.getElementById("locationInfo").textContent =
              "Không thể xác định";
          }
        );
      } else {
        document.getElementById("locationInfo").textContent = "Không hỗ trợ";
      }

      // Auto-run basic test on load
      setTimeout(() => {
        if (document.getElementById("apiUrl").value) {
          testConnection();
        }
      }, 1000);
    </script>
  </body>
</html>
